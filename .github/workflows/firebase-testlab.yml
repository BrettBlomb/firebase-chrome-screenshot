name: Android Firebase Test Lab

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  firebase-testlab:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------
    # Checkout repository
    # ----------------------------
    - name: Checkout code
      uses: actions/checkout@v4

    # ----------------------------
    # Decode Base64 service account JSON
    # ----------------------------
    - name: Decode service account key
      run: |
        echo "${{ secrets.FIREBASE_SA_KEY_BASE64 }}" | base64 --decode > $HOME/gcloud_key.json
        ls -l $HOME/gcloud_key.json
        echo "Service account JSON decoded."

    # ----------------------------
    # Set up gcloud using the decoded file
    # ----------------------------
    - name: Set up gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        service_account_key_file: $HOME/gcloud_key.json
        project_id: ${{ secrets.FIREBASE_PROJECT_ID }}
        export_default_credentials: true

    # ----------------------------
    # üîç DEBUG AUTHENTICATION
    # ----------------------------
    - name: Debug gcloud auth
      run: |
        echo "===== gcloud info ====="
        gcloud info || true

        echo "===== active account ====="
        gcloud auth list || true

        echo "===== GOOGLE_APPLICATION_CREDENTIALS ====="
        echo "$GOOGLE_APPLICATION_CREDENTIALS"

        echo "===== credentials file ====="
        if [ -f "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
          cat "$GOOGLE_APPLICATION_CREDENTIALS"
        else
          echo "CREDENTIAL FILE NOT FOUND"
        fi

    # ----------------------------
    # Enable required APIs
    # ----------------------------
    - name: Enable required APIs
      run: |
        gcloud services enable \
          toolresults.googleapis.com \
          testing.googleapis.com \
          storage.googleapis.com

    # ----------------------------
    # Build APKs
    # ----------------------------
    - name: Build APKs
      run: |
        chmod +x ./gradlew
        ./gradlew assembleDebug assembleAndroidTest

    # ----------------------------
    # Upload built APK artifacts
    # ----------------------------
    - name: Upload Built APKs
      uses: actions/upload-artifact@v4
      with:
        name: built-apks
        path: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk

    # ----------------------------
    # Run Firebase Test Lab
    # ----------------------------
    - name: Run tests in Firebase Test Lab
      run: |
        gcloud firebase test android run \
          --type instrumentation \
          --app app/build/outputs/apk/debug/app-debug.apk \
          --test app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
          --device model=Pixel2,version=30,locale=en,orientation=portrait \
          --results-bucket=${{ secrets.FIREBASE_RESULTS_BUCKET }} \
          --results-dir=github_artifacts_${{ github.run_id }}

    # ----------------------------
    # Download TestLab Results
    # ----------------------------
    - name: Download TestLab Results from Bucket
      run: |
        mkdir results
        gsutil -m cp -r gs://${{ secrets.FIREBASE_RESULTS_BUCKET }}/github_artifacts_${{ github.run_id }}/* results/

    # ----------------------------
    # Upload test results
    # ----------------------------
    - name: Upload TestLab Results Artifact
      uses: actions/upload-artifact@v4
      with:
        name: testlab-results
        path: results/
