name: Android Firebase Test Lab

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  firebase-testlab:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up gcloud
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.FIREBASE_SA_KEY }}
        project_id: ${{ secrets.FIREBASE_PROJECT_ID }}
        export_default_credentials: true

    - name: Enable required APIs
      run: |
        gcloud services enable \
          toolresults.googleapis.com \
          testing.googleapis.com \
          storage.googleapis.com

    - name: Build APKs
      run: |
        chmod +x ./gradlew
        ./gradlew assembleDebug assembleAndroidTest

    # Upload built APKs (Updated to v4)
    - name: Upload Built APKs
      uses: actions/upload-artifact@v4
      with:
        name: built-apks
        path: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk

    - name: Run tests in Firebase Test Lab
      run: |
        gcloud firebase test android run \
          --type instrumentation \
          --app app/build/outputs/apk/debug/app-debug.apk \
          --test app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
          --device model=Pixel2,version=30,locale=en,orientation=portrait \
          --results-bucket=${{ secrets.FIREBASE_RESULTS_BUCKET }} \
          --results-dir=github_artifacts_${{ github.run_id }}

    - name: Download TestLab Results from Bucket
      run: |
        mkdir results
        gsutil -m cp -r gs://${{ secrets.FIREBASE_RESULTS_BUCKET }}/github_artifacts_${{ github.run_id }}/* results/

    # Upload results (Updated to v4)
    - name: Upload TestLab Results Artifact
      uses: actions/upload-artifact@v4
      with:
        name: testlab-results
        path: results/
