name: Android Firebase Test Lab

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths-ignore:
      - "docs/latest_test.mp4"
      - "README.md"

jobs:
  firebase-testlab:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allows committing README & video updates

    steps:
    # -------------------------------
    # 1) Checkout Repository
    # -------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------
    # 2) SERVICE ACCOUNT KEY (Paste yours inside "")
    # -------------------------------
    - name: Create service account file
      run: |
        printf '%s' "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZmlyLWNocm9tZS1zY3JlZW5zaG90IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiNmViYzQ0YmFjM2FjYTJjOTg3ODI5M2NlNmQxYjUxNjgwNzRjMGNmYyIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZBSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS1l3Z2dTaUFnRUFBb0lCQVFEUWQ3MERublZCVUhXaFxuTzcvS01jMll0OERBM0RDSkhUVVJZQ1FSZlpiL21XbWtEMlFVTWpuZlI5cFVxM1lBY2Z0S0hyakJPYTc4TnFsL1xucXladUlMZjIwK05WWDZXenIyTUU2cE1MNTR5SzhsMjgzQy9YdkppenpxUjl4YVk1eGUrYWM4ZithN3VKNnNZWVxuellnVk50SlJXeGh0MGl1eTltQnBPRnNFRG9JMFdPQ1dzOGppQWhobkZDY2lHM2VxREJJTEZvQ1VuNjJBWVpwdVxuekgwV2xSV2R6aXZtR3FhQVVvUUNLMW9IVWU3SnZUS2V6cG5YM3dsYVZYODJxSUdlSThuVHZVR2hDTDdLOVZGelxuaTRQV3dmcHJJSTk0Z0F4UGcyYzBob2wrSWVxckh5MjBqWWk5ekMvOHZkRGVkL1ZwTzZoNytsZnRocCtsbWZUTVxuQ1lNRHh2TTdBZ01CQUFFQ2dnRUFCRTRzdzZuZW54SXowN2docm1IWDdxc0EycHJSajh0Z0lMTTlHM1ZlREhwVlxuSWJQRnE5c2JzZDVRaG9ZaUFrRllZTUFBcmREc3FiM1JRMWM4REhNMWlXMzMySGdJdW96SlBUMUErekoxaHhzWlxuVDRDMnBqeDVaT0ZFS1dyUEU0dGdkdTZrTno5dldKcFdMQVgycFFXRVUzVFByTmoxMlJUWWllUEZrWEJoUlFaMVxuVG41SnBIRVZLSmJoNVJWSlJFZThjVHhGU2NYbjVQbEo3V0NhS3N5U0lQNnpTZ3haOFJ2TXphTUVHNVVHODZ6ZVxuSG9GS1ZFSTMvN0dxWlRIdEJRMzFPV09QRkkzNTNJdGJBSDRmVjhFWTlYWG9ibTI4T0dURXU1ZnhBWDJQTnIwblxuMmZPMG4xN0ExZUhXeUg2ZTU5YUdxcWpXSkJ6KzRqdnZMTUQ3ais5bEhRS0JnUUQ2RVIvWUhvVi96cjhqN3JkaFxuMk9pdXFBcnB1bmp2Ylg2UE83blRZZ3BLeEpMMVdOc1Fzd2xJcFdJcUIrNUFVektld0dYWmNydGc5ZldKc3NlclxucGFkN1NUZmFPeWdGWFVzUHN6U1FaSHpBenlwdnBJYkc5L05tb2cxdkw5K1pVQmtzQTFSaElVaEVFcFNJZ3RxdlxuRUh6TWltTHV1SllOMU1YeWNaRnIycE5RTndLQmdRRFZhZkliTHBkdlZJU1ZnYWtPRExkeE13N2xEWTkrYzRDZFxuajljVFc3STkxVEoxZlBTd0dZN2FEKzlZN1gxK0dZVFpCZlRYTFZXS3RyYkJ6OW44ZHRXM2l0aUpVN1cyQlIva1xuaU0zQzlKbEIwMmVJcEYrcFgxSEFZcTYwZDVMYVBHaFhpb2lVUWZEcjQ1cGJUYUxmanFuRTdaNXlZN25RZU5GNVxuR09jT01UK0xIUUtCZ0FwMmFQU3I0ajRFc202WWNFZkJ3WXA5TVdleUM1bEk1WUNzcVF1MUVHVXNjRkdmbEJyUVxud3RTdFJyd25kTXB3TUsvL3NNTTJUNnl3M2NNVEhkT0tyTVUxdlFaK2J5QTZWUWVsSWMvZ3hHOTB1M3ZNVUc5R1xudElKWXlXTWJoNmxzZG9FbTZvTGQxNTR4Z05GdFdDVDI5YUhCTUg1NGJwN0poamFzbGI4RGVDSmxBb0dBS3V3bFxuQ255RGJwdkVFc0hDTzVZcEt2Wkc3NkNibEtZc1h3UTRFS2Vub0xJSmRRSE53TUZUTHQ1M21CNGoyRUhQcTBwOFxuWk82MFByTGk3UFlkOUozOSsrMU1BY3E1U0VPZGwzeEFUZzZkNkZSWmhXeng1SUhNVW5KR2l2dGxxTWp2ZjNQWVxuWm1FZzBJQzFZZG1xZ1dZVEZRMXBpYjR1K0JQa3BZTnhyVFFRZ0swQ2dZQkpVOFgzUlNwOGlCRVJydVFGT3pPU1xuU3JKRm5DY3RJam01dE5DbjJ5dnI5UjI5MGl6aWNZR3dMKzZxbnNML0NwNFNIOUhHV296dmUrMkdBcHRIRkwvV1xub0lPUElVT1A3bmlzSW5pZjdIK2VJYURzM2VvY3BGSWdvbXpxTWk2eE8yRHZpQkxSdHduK2o2YitKOE1BeFlqUVxudkRIa0k2aEUrV3lYOGx0SmptcUxNZz09XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiZmlyZWJhc2UtYWRtaW5zZGstZmJzdmNAZmlyLWNocm9tZS1zY3JlZW5zaG90LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjEwMDM0NjA3OTY4ODMyOTc2MzM0NCIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvZmlyZWJhc2UtYWRtaW5zZGstZmJzdmMlNDBmaXItY2hyb21lLXNjcmVlbnNob3QuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K" > key.b64
        base64 -d key.b64 > sa-key.json

    # -------------------------------
    # 3) Authenticate with gcloud
    # -------------------------------
    - name: Authenticate with gcloud
      run: |
        gcloud auth activate-service-account --key-file=sa-key.json
        gcloud config set project fir-chrome-screenshot

    - name: Enable APIs
      run: |
        gcloud services enable \
          toolresults.googleapis.com \
          testing.googleapis.com \
          storage.googleapis.com

    # -------------------------------
    # 4) Build the APKs
    # -------------------------------
    - name: Build APKs
      run: |
        chmod +x ./gradlew
        ./gradlew assembleDebug assembleAndroidTest

    # -------------------------------
    # 5) Auto-pick Firebase device + OS
    # -------------------------------
    - name: Pick Random Firebase Device
      id: pickdevice
      run: |
        MODELS=$(gcloud firebase test android models list --format="json")
        echo "$MODELS" > models.json

        PHONE_MODELS=$(jq '[ .[] | select(.formFactor=="PHONE") ]' models.json)
        RANDOM_MODEL=$(echo "$PHONE_MODELS" | jq -r '.[].id' | shuf -n 1)
        RANDOM_VERSION=$(echo "$PHONE_MODELS" \
          | jq -r --arg M "$RANDOM_MODEL" '.[] | select(.id==$M) | .supportedVersionIds[]' \
          | shuf -n 1)

        echo "MODEL=$RANDOM_MODEL" >> $GITHUB_ENV
        echo "VERSION=$RANDOM_VERSION" >> $GITHUB_ENV

    # -------------------------------
    # 6) Run Firebase Test Lab + extract result URL
    # -------------------------------
    - name: Run Firebase Test Lab
      id: runftl
      run: |
        echo "Using device: $MODEL  OS: $VERSION"

        gcloud firebase test android run \
          --type instrumentation \
          --format=json \
          --app app/build/outputs/apk/debug/app-debug.apk \
          --test app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
          --device model=$MODEL,version=$VERSION,locale=en,orientation=portrait \
          --results-bucket=fir-chrome-screenshot-results \
          --results-dir=github_${{ github.run_id }} \
          2>&1 | tee ftl_full_output.log

        FTL_URL=$(grep -o 'https://console.firebase.google.com[^ ]*' ftl_full_output.log | head -n 1)

        echo "FTL_URL=$FTL_URL" >> $GITHUB_ENV

        echo "============================="
        echo "ðŸ”¥ VIEW RESULTS ðŸ”¥"
        echo "$FTL_URL"
        echo "============================="

    # -------------------------------
    # 7) Download all test results
    # -------------------------------
    - name: Download Test Results
      run: |
        mkdir results
        gsutil -m cp -r gs://fir-chrome-screenshot-results/github_${{ github.run_id }}/* results/ || true

    # -------------------------------
    # 8) Locate test video
    # -------------------------------
    - name: Locate Test Video
      run: |
        VIDEO_PATH=$(find results -type f -name "*.mp4" | head -n 1)
        echo "VIDEO_PATH=$VIDEO_PATH" >> $GITHUB_ENV
        echo "Found video: $VIDEO_PATH"

    # -------------------------------
    # 9) Commit test video to /docs/
    # -------------------------------
    - name: Commit Latest Test Video
      run: |
        mkdir -p docs
        cp "$VIDEO_PATH" docs/latest_test.mp4

        git config user.email "github-actions@github.com"
        git config user.name "GitHub Actions"

        git add docs/latest_test.mp4
        git commit -m "Update test video [skip ci]" || echo "No video changes"
        git push

    # -------------------------------
    # 10) Update README with Status + Video (SAFE VERSION)
    # -------------------------------
    - name: Update README with Test Status & Video
      run: |
        STATUS="Unknown"
        if grep -qi "Passed" ftl_full_output.log; then
          STATUS="Passed"
        else
          STATUS="Failed"
        fi

        # Create README template without expanding variables
        cat > README.md << 'EOF'
# Android Firebase Test Lab (Automated)

**Latest Test Status:** __STATUS__  
**Last Run ID:** __RUNID__  
**Device:** __DEVICE__  
**OS Version:** __VERSION__  

### ðŸ”— View Full Firebase Results  
__FTLURL__

---

### ðŸ“¹ Latest Test Video  
<video controls width="420">
  <source src="docs/latest_test.mp4" type="video/mp4">
Your browser does not support the video tag.
</video>

EOF

        # Replace placeholders
        sed -i "s|__STATUS__|$STATUS|g" README.md
        sed -i "s|__RUNID__|${{ github.run_id }}|g" README.md
        sed -i "s|__DEVICE__|$MODEL|g" README.md
        sed -i "s|__VERSION__|$VERSION|g" README.md
        sed -i "s|__FTLURL__|$FTL_URL|g" README.md

        git add README.md
        git commit -m "Update README with latest test results [skip ci]" || echo "No README updates"
        git push

    # -------------------------------
    # 11) Upload test results as artifact
    # -------------------------------
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: firebase-results
        path: results/
